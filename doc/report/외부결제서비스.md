## **외부 결제 서비스를 거치는 결제 처리의 트랜잭션 범위 최적화**

### **1. 첫 번째 설계 방식**

#### **[해결책의 간단한 순서]**

1. **트랜잭션 1: 결제 초기화**

   - 내부 데이터베이스에서 `isSuccess = false`로 설정하여 "결제 중" 상태로 표시.
   - 트랜잭션 종료.

2. **외부 결제 서비스 호출**

   - 외부 결제 API에 요청 전송.
   - 성공 또는 실패 응답을 대기.

3. **트랜잭션 2: 결제 결과 반영**

   - **성공 시**:
     - `isSuccess = true`로 상태 변경.
     - 잔여 금액 업데이트.
   - **실패 시**:
     - `isSuccess = false` 유지, 추가 작업 없음.

4. **사용자 응답**
   - **성공**: 결제 완료 정보 및 잔여 금액 반환.
   - **실패**: 결제 실패 메시지 반환.

---

### **2. 단점 및 고려 사항**

#### **1) 중간 상태 관리**

- **문제**:

  - `isSuccess = false`로 설정한 후, 외부 결제 서비스 처리 중 "결제 중" 상태가 유지됨.
  - 외부 결제가 지연되거나 사용자가 결제를 취소할 경우 처리 로직이 필요.

- **해결책**:
  - 일정 시간 안에 외부 결제 응답이 없으면 "결제 실패" 상태로 자동 전환.
  - 사용자가 결제를 취소할 경우 중간 상태를 클린업(`isSuccess = false` 유지).

---

#### **2) 결제 실패 시 재처리**

- **문제**:

  - 외부 결제 서비스에서 실패 응답이 오면 상태를 복구하고 적절히 처리해야 함.

- **해결책**:
  - `isSuccess`를 계속 `false`로 유지하여 결제 실패 상태를 명확히 관리.
  - 실패 사유를 로그로 기록하고, 필요 시 재시도 로직 추가.
  - 사용자에게 결제 실패 상태와 사유를 명확히 알림.

---

#### **3) 데이터 동기화**

- **문제**:

  - 외부 결제 서비스의 응답 지연 또는 실패 시, 내부 데이터와 외부 결제 상태 불일치 가능성.
  - 사용자에게 정확한 상태를 보여주는 데 어려움 발생.

- **해결책**:
  - 외부 서비스와 상태 동기화를 위한 백그라운드 작업 추가(예: 상태 확인 API 또는 Webhook).
  - UI에서 "결제 진행 중" 상태를 명확히 표시하고, 응답 지연 시 적절한 메시지 안내.
  - 일정 시간이 지나면 자동으로 "결제 실패" 상태로 전환하여 사용자 혼란 방지.
