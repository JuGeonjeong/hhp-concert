# 동시성 이슈 및 제어 방안 보고서

## 개요

본 보고서는 **포인트 충전 및 결제, 좌석 예약 시스템, 만료 좌석 관리 스케줄러**에서 발생할 수 있는 동시성 문제를 파악하고, 이를 해결하기 위해 도입된 **Mutex, 비관적 락(Pessimistic Lock), 낙관적 락(Optimistic Lock)** 등의 동시성 제어 방안을 정리한 내용입니다. 각 방안에 따른 **구현의 복잡도, 성능, 효율성** 등을 평가하며, README 문서에 추가된 링크로 상세 정보를 확인할 수 있습니다.

---

## 1. 포인트 충전 및 결제

### 1.1 동시성 문제 정의 및 필요성

포인트 충전 및 결제 시스템에서는 아래와 같은 동시성 문제가 발생할 수 있습니다:

- **중복 결제**: 여러 사용자가 동시에 결제를 시도할 경우, 잔액이 부족한 상황에서도 중복 결제가 처리되는 상황이 발생할 수 있습니다.
- **일관성 손실**: 충전과 결제가 거의 동시에 발생할 때 포인트 잔액이 정확하게 반영되지 않거나, 잔액 불일치로 인해 사용자가 예상하지 못한 오류가 발생할 수 있습니다.

이러한 문제는 포인트 시스템의 신뢰도와 정확성에 영향을 미칠 수 있으므로, **충전과 결제 작업에 대한 강력한 동시성 제어가 필요**합니다.

### 1.2 구현 방안 및 동시성 제어 방식

#### 1) Mutex 적용

- **설명**: 포인트 충전 및 결제 시 **Mutex를 사용하여 작업이 완료될 때까지 다른 작업이 동일한 포인트 자원에 접근하지 못하도록 제어**합니다.
- **장점**: 코드 수준에서 간단하게 동시성 문제를 제어할 수 있으며, **포인트 데이터의 일관성을 유지**할 수 있습니다.
- **단점**: 충전과 결제 요청이 많아질 경우, 작업이 완료될 때까지 다른 요청이 대기해야 하므로 **처리 속도가 느려질 수 있습니다**.
- **복잡도**: 상대적으로 낮은 구현 복잡도.
- **성능**: 충전 및 결제가 동시에 발생하면 **대기 시간 증가 가능**.

#### 2) DB 쓰기 락(Pessimistic Lock)

- **설명**: DB에서 **쓰기 락을 설정하여 트랜잭션이 완료될 때까지 다른 트랜잭션이 포인트 데이터를 수정하지 못하도록 보장**합니다.
- **장점**: DB에서 자원에 직접 락을 걸어 **데이터베이스 수준에서 일관성을 강력하게 보장**할 수 있습니다.
- **단점**: 성능이 저하될 가능성이 있으며, 다수의 사용자가 동시에 포인트를 충전 및 결제할 경우 **대기 시간이 발생할 수 있습니다**.
- **복잡도**: 트랜잭션과 락 관리가 필요하여 **중간 수준의 복잡도**.
- **성능**: 충전 및 결제가 잦을 경우 **병목 발생 가능성 존재**.

---

## 2. 좌석 예약 시스템

### 2.1 문제 정의

좌석 예약 시스템에서는 **동일 좌석을 여러 사용자가 동시에 예약하려고 할 가능성이 매우 높습니다**. 이로 인해 **좌석이 중복 예약되거나, 예약 상태가 일관성 없이 변경되는 문제가 발생**할 수 있습니다. 이는 사용자의 혼란을 초래하고 예약 시스템의 신뢰성을 떨어뜨릴 수 있습니다.

### 2.2 구현 방안 및 동시성 제어 방식

#### 낙관적 락(Optimistic Lock)

- **설명**: **낙관적 락을 사용하여 좌석 예약 시 충돌을 감지**하고, 충돌이 발생한 경우에만 예외를 발생시킵니다. 성공적인 예약 하나만을 보장하며, 나머지 실패한 예약 요청에 대해서는 **에러를 반환하여 재시도 또는 실패 처리가 가능합니다**.
- **장점**: 충돌이 발생할 경우에만 예외가 발생하므로 **성능 저하를 최소화**하고, 좌석 예약에 성공한 사례만 처리하면 되므로, **데이터 일관성이 용이하게 관리**됩니다.
- **단점**: 충돌이 자주 발생할 경우 **재시도 로직이 추가로 필요**할 수 있으며, **데이터베이스 버전 관리**가 요구됩니다.
- **복잡도**: 낙관적 락으로 인한 **버전 관리와 재시도 로직이 필요**하여 **중간 수준의 복잡도**.
- **성능**: 충돌 발생이 드문 경우 **성능 최적화 가능**, 단 충돌 시 성능 저하 발생 가능성 존재.

---

## 3. 만료 좌석 관리 스케줄러

### 3.1 문제 정의

만료된 좌석을 정기적으로 조회하여 **예약 상태를 변경해야 하며**, 이 과정에서 다른 트랜잭션이 동시에 동일 좌석을 예약하려는 문제가 발생할 수 있습니다. 만약 만료된 좌석을 처리하는 도중에 다른 사용자가 예약을 시도한다면, **예약 상태와 좌석 상태가 충돌할 가능성**이 있습니다.

### 3.2 구현 방안 및 동시성 제어 방식

#### 비관적 락(Pessimistic Lock)

- **설명**: 만료된 좌석을 조회하고 처리할 때 **비관적 락을 걸어 다른 트랜잭션이 좌석 상태를 수정하지 못하도록 강제**합니다.
- **장점**: 다른 트랜잭션이 동시에 만료 좌석을 예약하지 못하게 하여 **데이터 일관성과 안정성을 높일 수 있습니다**.
- **단점**: 비관적 락을 걸면 해당 좌석에 대한 다른 트랜잭션이 대기해야 하므로 **대기 시간이 길어질 수 있으며, 성능이 저하될 가능성이 있습니다**.
- **복잡도**: 상대적으로 낮은 복잡도. **트랜잭션 내 락 설정이 주 구현 요소**.
- **성능**: 많은 좌석 만료 작업이 동시에 진행될 경우 **병목 발생 가능성**.
